<template id="template-carousel-panel">
  <style>
    :host {
      display: inline-block;
    }
    :host .carousel {
      overflow: hidden;
      visibility: hidden;
      position: relative;
    }
    :host .carousel-wrap {
      overflow: hidden;
      position: relative;
    }
    ::content img {
      float: left;
      position: relative;
    }
  </style>
  <div id="container" class="carousel">
    <div id="wrap" class="carousel-wrap">
      <content></content>
    </div>
  </div>
</template>

<script>
  window.CarouselPanel = (function () {
    var currentScript = document.currentScript;
    var ownerDocument = currentScript.ownerDocument;
    var CarouselPanelPrototype = Object.create(HTMLElement.prototype);

    var isTouchDevice = 'ontouchstart' in window;
    var swipeStart    = isTouchDevice ? 'touchstart' : 'mousedown';
    var swipeMove     = isTouchDevice ? 'touchmove'  : 'mousemove';
    var swipeEnd      = isTouchDevice ? 'touchend'   : 'mouseup';
    var panelWidth    = 0;
    var lastIndex     = 0;

    CarouselPanelPrototype.createdCallback = function () {

      var template = ownerDocument.querySelector('#template-carousel-panel');
      var clone = document.importNode(template.content, true);

      this.shadowRoot = this.createShadowRoot();
      this.shadowRoot.appendChild(clone);
    };

    CarouselPanelPrototype.attachedCallback = function () {

      var container = this.shadowRoot.querySelector('#container');
      var wrap = container.querySelector('#wrap');
      var images = this.getElementsByTagName('img');

      var width = 0;
      var maxWidth = 0;
      var totalWidth = 0;
      for (var i = 0, l = images.length;i < l;i++) {
        width = images[i].width;
        if (maxWidth < width) {
          maxWidth = width;
        }
        totalWidth += width;
      }

      lastIndex = images.length - 1;
      panelWidth = maxWidth;

      container.style.width = maxWidth + 'px';
      wrap.style.width = totalWidth + 'px';
      wrap.addEventListener(swipeStart, onSwipeStart);

      var currentIndex = 0;
      var startPoint;
      var moveDistance;

      function onSwipeStart(e) {

        e.preventDefault();

        if (isTouchDevice) {
          if (e.touches.length > 1 || e.scale && e.scale !== 1) {
            return;
          }
        }

        var offset = {
          x: isTouchDevice ? e.touches[0].pageX : e.pageX,
          y: isTouchDevice ? e.touches[0].pageY : e.pageY
        };

        startPoint = {
          x: offset.x,
          y: offset.y
        };

        wrap.addEventListener(swipeMove, onSwipeMove);
        wrap.addEventListener(swipeEnd, onSwipeEnd);
      }

      function onSwipeMove(e) {

        var offset = {
          x: isTouchDevice ? e.touches[0].pageX : e.pageX,
          y: isTouchDevice ? e.touches[0].pageY : e.pageY
        };

        moveDistance = {
          x: offset.x - startPoint.x,
          y: offset.y - startPoint.y
        };

        var distance = -panelWidth * currentIndex + moveDistance.x;

        wrap.style.transform = 'translate(' + distance + 'px, 0)';
      }

      function onSwipeEnd(e) {

        if (Math.abs(moveDistance.x) > panelWidth / 2) {
          if (moveDistance.x < 0) {
            if (currentIndex !== lastIndex) {
              currentIndex++;
            }
          } else {
            if (currentIndex !== 0) {
              currentIndex--;
            }
          }
        }

        var distance = -panelWidth * currentIndex;

        wrap.style.transitionDuration = '100ms';
        wrap.style.transform = 'translate(' + distance + 'px, 0)';

        wrap.removeEventListener(swipeMove, onSwipeMove);
        wrap.removeEventListener(swipeEnd, onSwipeEnd);
      }

      container.style.visibility = 'visible';
    };

    return document.registerElement('carousel-panel', {
      prototype: CarouselPanelPrototype
    });
  })();
</script>
